<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drive Settings</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7fb; color: #111827; }
        .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
        .header { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 12px; }
        .tableWrap { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #e5e7eb; font-size: 13px; }
        th { background: #f9fafb; color: #374151; font-weight: 600; }
        .muted { color: #6b7280; }
        .formGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; align-items: start; }
        label { display:block; font-size: 13px; color: #374151; margin-bottom: 4px; }
        input[type="text"], input[type="file"] { width: 100%; max-width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; }
        button { border: 1px solid #d1d5db; background: #fff; border-radius: 8px; padding: 8px 10px; cursor: pointer; font-size: 13px; }
        button:hover { background: #f9fafb; }
        .actions { display:flex; gap: 8px; flex-wrap: wrap; }
        .badge { display:inline-flex; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; border: 1px solid #e5e7eb; }
        .badge.active { background: #ecfdf5; color: #065f46; border-color: #a7f3d0; }
        .error { color: #991b1b; }
        .success { color: #065f46; }
        .modalOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 9999; }
        .modal { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; max-width: 820px; width: 100%; padding: 16px; }
        .modalHeader { display:flex; justify-content: space-between; align-items:center; gap: 12px; margin-bottom: 8px; }
        .modalBody { font-size: 13px; color: #111827; line-height: 1.5; }
        .modalBody code { background: #f3f4f6; padding: 2px 6px; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <button id="backBtn" type="button" aria-label="Back" title="Back" style="width: 36px; height: 36px; padding: 0; display:flex; align-items:center; justify-content:center;">
                    <span style="font-size:18px; line-height:1;">&larr;</span>
                </button>
                <button id="infoBtn" type="button" aria-label="Info" title="Info" style="width: 36px; height: 36px; padding: 0; display:flex; align-items:center; justify-content:center;">
                    <span style="font-size:16px; line-height:1; font-weight:700;">i</span>
                </button>
                <h2 style="margin: 0;">Drive Settings</h2>
            </div>
            <div class="muted">Active profile: {% if active_profile %}{{ active_profile.name }}{% else %}-{% endif %}</div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">Create Drive Profile (Service Account JSON)</h3>
            <div class="formGrid">
                <div>
                    <label>Profile name</label>
                    <input id="name" type="text" placeholder="e.g. Ops Service Account" />
                </div>
                <div>
                    <label>Credentials JSON file</label>
                    <input id="credentials" type="file" accept="application/json,.json" />
                </div>
                <div>
                    <label>Root Folder ID (optional)</label>
                    <input id="rootFolderId" type="text" placeholder="Google Drive folder ID" />
                </div>
            </div>
            <div style="margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <label style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="setActive" type="checkbox" />
                    Set active immediately
                </label>
                <div class="actions">
                    <button id="createBtn" type="button">Create</button>
                </div>
            </div>
            <div id="createMsg" class="muted" style="margin-top:10px;"></div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">Profiles</h3>
            <div class="tableWrap">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Root Folder ID</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Default (ENV)</td>
                            <td class="muted">-</td>
                            <td>
                                {% if not active_profile %}
                                    <span class="badge active">Active</span>
                                {% else %}
                                    <span class="badge">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="actions">
                                    <button type="button" class="openExplorerBtn" data-profile="">Open Explorer</button>
                                </div>
                            </td>
                        </tr>
                    {% for p in profiles %}
                        <tr>
                            <td>{{ p.name }}</td>
                            <td class="muted">{{ p.root_folder_id|default:"-" }}</td>
                            <td>
                                {% if p.is_active %}
                                    <span class="badge active">Active</span>
                                {% else %}
                                    <span class="badge">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="actions">
                                    <button type="button" class="openExplorerBtn" data-profile="{{ p.id }}">Open Explorer</button>
                                    <button type="button" class="activateBtn" data-id="{{ p.id }}">Activate</button>
                                    <button type="button" class="setRootBtn" data-id="{{ p.id }}">Set Root</button>
                                    <button type="button" class="createRootBtn" data-id="{{ p.id }}">Create Root</button>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="4" class="muted">No profiles yet</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div id="actionMsg" class="muted" style="margin-top:10px;"></div>
        </div>
    </div>

    <div id="infoModal" class="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal">
            <div class="modalHeader">
                <div style="font-weight:700;">Drive Settings: prerequisites &amp; how it works</div>
                <button id="infoCloseBtn" type="button" aria-label="Close">Close</button>
            </div>
            <div class="modalBody">
                <div style="margin-bottom:10px;">
                    <div style="font-weight:700; margin-bottom:4px;">Prerequisites</div>
                    <div class="muted">
                        Upload a Google <code>Service Account</code> JSON key. Share your target root folder with the service account email as Editor, or add the service account as a member of the Shared Drive.
                    </div>
                </div>
                <div style="margin-bottom:10px;">
                    <div style="font-weight:700; margin-bottom:4px;">What changes when you switch profiles</div>
                    <div class="muted">Activating a profile switches the account used by backend APIs and processing jobs.</div>
                </div>
                <div>
                    <div style="font-weight:700; margin-bottom:4px;">How the Explorer reads data</div>
                    <div class="muted">
                        Account: <code>about.get</code>, Folder metadata: <code>files.get</code>, Listing: <code>files.list</code> with pagination.
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
(function(){
    const backBtn = document.getElementById('backBtn');
    backBtn.addEventListener('click', () => { window.location.href = '/drive-explorer/'; });

    const infoBtn = document.getElementById('infoBtn');
    const infoModal = document.getElementById('infoModal');
    const infoCloseBtn = document.getElementById('infoCloseBtn');

    function openInfoModal(){
        infoModal.style.display = 'flex';
        infoModal.setAttribute('aria-hidden', 'false');
    }

    function closeInfoModal(){
        infoModal.style.display = 'none';
        infoModal.setAttribute('aria-hidden', 'true');
    }

    infoBtn.addEventListener('click', openInfoModal);
    infoCloseBtn.addEventListener('click', closeInfoModal);
    infoModal.addEventListener('click', (e) => {
        if (e.target === infoModal) closeInfoModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeInfoModal();
    });

    function showMsg(el, text, cls){
        el.className = cls || 'muted';
        el.textContent = text || '';
    }

    async function postForm(url, formData){
        const res = await fetch(url, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        });
        const data = await res.json().catch(() => null);
        if (!res.ok) {
            const msg = (data && (data.error || data.message)) || `HTTP ${res.status}`;
            throw new Error(msg);
        }
        return data;
    }

    const createBtn = document.getElementById('createBtn');
    const createMsg = document.getElementById('createMsg');

    createBtn.addEventListener('click', async () => {
        try {
            showMsg(createMsg, 'Creating...', 'muted');
            const name = document.getElementById('name').value;
            const rootFolderId = document.getElementById('rootFolderId').value;
            const setActive = document.getElementById('setActive').checked;
            const file = document.getElementById('credentials').files[0];

            const fd = new FormData();
            fd.append('name', name);
            fd.append('root_folder_id', rootFolderId);
            if (setActive) fd.append('set_active', 'on');
            if (file) fd.append('credentials_file', file);

            await postForm('/api/drive/settings/profiles/create/', fd);
            showMsg(createMsg, 'Created. Reloading...', 'success');
            window.location.reload();
        } catch (e) {
            showMsg(createMsg, e.message, 'error');
        }
    });

    const actionMsg = document.getElementById('actionMsg');

    document.querySelectorAll('.openExplorerBtn').forEach(btn => {
        btn.addEventListener('click', () => {
            const pid = btn.getAttribute('data-profile') || '';
            const url = pid ? `/drive-explorer/?profile_id=${encodeURIComponent(pid)}` : '/drive-explorer/';
            window.location.href = url;
        });
    });

    document.querySelectorAll('.activateBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
            try {
                showMsg(actionMsg, 'Activating...', 'muted');
                const id = btn.getAttribute('data-id');
                await postForm(`/api/drive/settings/profiles/${id}/activate/`, new FormData());
                showMsg(actionMsg, 'Activated. Reloading...', 'success');
                window.location.reload();
            } catch (e) {
                showMsg(actionMsg, e.message, 'error');
            }
        });
    });

    document.querySelectorAll('.setRootBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
            try {
                const id = btn.getAttribute('data-id');
                const root = window.prompt('Enter Root Folder ID');
                if (!root) return;
                showMsg(actionMsg, 'Updating root folder...', 'muted');
                const fd = new FormData();
                fd.append('root_folder_id', root);
                await postForm(`/api/drive/settings/profiles/${id}/root/`, fd);
                showMsg(actionMsg, 'Root updated. Reloading...', 'success');
                window.location.reload();
            } catch (e) {
                showMsg(actionMsg, e.message, 'error');
            }
        });
    });

    document.querySelectorAll('.createRootBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
            try {
                const id = btn.getAttribute('data-id');
                const folderName = window.prompt('New root folder name');
                if (!folderName) return;
                const parentId = window.prompt('Optional parent folder ID (leave blank for none)') || '';
                showMsg(actionMsg, 'Creating root folder...', 'muted');
                const fd = new FormData();
                fd.append('folder_name', folderName);
                if (parentId) fd.append('parent_id', parentId);
                const res = await postForm(`/api/drive/settings/profiles/${id}/create-root/`, fd);
                showMsg(actionMsg, `Created and set root: ${res.root_folder_id}. Reloading...`, 'success');
                window.location.reload();
            } catch (e) {
                showMsg(actionMsg, e.message, 'error');
            }
        });
    });
})();
</script>
</body>
</html>
